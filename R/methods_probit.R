#' @title The \code{probit} class and some basic methods
#'
#' @name probit-class
#' @description
#' Objects of class \code{probit} as generated by \code{\link{probit}} is a list with entries as specified below.
#' \describe{
#'   \item{\code{regression}}{List indexed by \code{items} of objects of class \code{clm} fitted by \code{\link[ordinal]{clm}}}
#'   \item{\code{Gamma}}{Cholesky factor of estimated variance of random effects}
#'   \item{\code{dependence}}{Text string (\code{marginal} or \code{joint}) specifying the used correlation structure}
#'   \item{\code{items}}{Vector with item names}
#'   \item{\code{subject}}{Name of subject variable inside data}
#'   \item{\code{random.eff}}{Vector with names of random effects}
#'   \item{\code{data}}{Tibble with dataset analyzed}
#' }
#' @param x Object of class \code{probit}.
#' @param y Object of class \code{probit}.

#' @rdname probit-class
#' @export
print.probit <- function(x) {
  cat("Probit regression with",length(x$regression),"items\n")
  cat("Total log(likelihood)=",sum(sapply(x$regression, logLik)),"\n")
}

#' @rdname probit-class
#' @export
summary.probit <- function(x) {
  cat("Probit regression with",length(x$regression),"items and",nrow(x$Gamma),"random effects\n")
  cat("\n")
  cat("Total log(likelihood)=",sum(sapply(x$regression, logLik)),"\n")
  cat("Individual likelihoods:\n")
  print(sapply(x$regression,logLik))
  cat("\n")
  if (x$dependence=="marginal") {
    cat("Variance of random effects (fitted as jointly independent):\n")
  } else {
    cat("Variance of random effects (fitted as jointly dependent):\n")
  }
  print(t(x$Gamma)%*%(x$Gamma))
  cat("\n")
  cat("Individual item regressions:\n")
  print(x$regression)
}

#' @rdname probit-class
#' @export
anova.probit <- function(x,y) {
  # sanity check
  if (!base::setequal(x$items,y$items)) stop("Models must be fitted on the same items")
  # set-up tibble with results
  res <- matrix(0,1+length(x$items),4)
  colnames(res) <- c("LR.stat","df.fixed","df.random","Pr(>Chisq)")
  res <- bind_cols(tibble(item=c("all.items",x$items)),as_tibble(res))
  # extract likelihood ratio tests
  pm <- ifelse(sum(sapply(x$regression,function(u){length(coef(u))}))+nrow(x$Gamma) >
               sum(sapply(y$regression,function(u){length(coef(u))}))+nrow(y$Gamma),
               1,-1)
  for (i in 1:length(x$items)) {
    tmp <- anova(x$regression[[i]],y$regression[[i]])
    res$LR.stat[1+i]      <- tmp[2,"LR.stat"]
    res$df.fixed[1+i]     <- tmp[2,"df"]
    res$df.random[1+i]    <- pm*(nrow(x$Gamma)-nrow(y$Gamma))/length(x$items)
    res$"Pr(>Chisq)"[1+i] <- 1-pchisq(res$LR.stat[1+i],df=res$df.fixed[1+i]+res$df.random[1+i])
  }
  # find overall likelihood ratio test
  res$LR.stat[1]      <- sum(res$LR.stat[-1])
  res$df.fixed[1]     <- sum(res$df.fixed[-1])
  res$df.random[1]    <- sum(res$df.random[-1])
  res$"Pr(>Chisq)"[1] <- 1-pchisq(res$LR.stat[1],df=res$df.fixed[1]+res$df.random[1])
  # return result
  res
}
